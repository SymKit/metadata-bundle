name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    security:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.3'
            - run: composer install --no-progress --prefer-dist
            - run: composer audit --abandoned=report

    cs:
        name: Code Style
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.3'
            - run: composer install --no-progress --prefer-dist
            - run: make cs-check

    phpstan:
        name: PHPStan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.3'
            - run: composer install --no-progress --prefer-dist
            - run: make phpstan

    deptrac:
        name: Deptrac
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.3'
            - run: composer install --no-progress --prefer-dist
            - run: make deptrac

    tests:
        name: Tests (PHP ${{ matrix.php }}, Symfony ${{ matrix.symfony }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - php: '8.2'
                      symfony: '7.2.*'
                    - php: '8.3'
                      symfony: '7.2.*'
                    - php: '8.4'
                      symfony: '7.2.*'
                    - php: '8.4'
                      symfony: '8.0.*'
        steps:
            - uses: actions/checkout@v4
            - uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  coverage: xdebug
            - name: Install Symfony ${{ matrix.symfony }}
              run: |
                  composer require --no-update symfony/config:${{ matrix.symfony }} symfony/dependency-injection:${{ matrix.symfony }} symfony/event-dispatcher:${{ matrix.symfony }} symfony/http-kernel:${{ matrix.symfony }} symfony/routing:${{ matrix.symfony }} symfony/framework-bundle:${{ matrix.symfony }}
                  composer update --no-progress --prefer-dist
            - run: make test

    infection:
        name: Mutation Testing
        runs-on: ubuntu-latest
        needs: tests
        steps:
            - uses: actions/checkout@v4
            - uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.3'
                  coverage: xdebug
            - run: composer install --no-progress --prefer-dist
            - run: make infection
